entities:
    household:
        fields:
            # period and id are implicit
            - income: float

        links:
            persons: {type: one2many, target: person, field: hh_id}

        processes:
            sumlink1:
                - r: persons.sum(earnings)
            sumlink2:
                - r: persons.sum(earnings, age > 1)
            countlink1:
                - r: persons.count()
            countlink2:
                - r: persons.count(age > 1)
            minlink1:
                - r: persons.min(earnings)
            minlink2:
                - r: persons.min(earnings, age > 1)
            avglink1:
                - r: persons.avg(earnings)
            avglink2:
                - r: persons.avg(earnings, age > 1)

    person:
        fields:
            # period and id are implicit
            - age:        int
            - earnings:   float
            - male:       bool

            - partner_id: int
            - hh_id:      int

        links:
            partner: {type: many2one, target: person, field: partner_id}
            household: {type: many2one, target: household, field: hh_id}

        processes:
            birth: new('person', number=10000000,
                       age=randint(0, 100),
                       male=choice([False, True]),
                       partner_id=-1,
                       hh_id=-1)

            earnings: 40 + age

            marriage:
                - to_marry: uniform() < 0.5
                - partner_id: matching(set1filter=to_marry and not male,
                                       set2filter=to_marry and male,
                                       orderby=age,
                                       score=  0.0467 * (other.age - age)
                                             - 0.0189 * (other.age - age) ** 2
                                             + 0.0003 * (other.age - age) ** 3,
                                       algo='byvalue')
                - just_married: to_marry and (partner_id != -1)
                - newhousehold: new('household', filter=just_married and not male,
                                    income=0.0)

                - hh_id: where(just_married,
                               where(male, partner.newhousehold, newhousehold),
                               hh_id)
            link:
                - r1: partner.age
                - r2: household.income
            test_agg:
                - gini1: gini(earnings)
                - gini2: gini(earnings, filter=age > 1)
                - avg1: avg(earnings)
                - avg2: avg(earnings, filter=age > 1)

simulation:
    init:
        - person: [birth, earnings, marriage]

    processes:
        - person: [link, test_agg]
        - household: [sumlink1, sumlink2,
                      countlink1, countlink2]
#        - household: [sumlink1, sumlink2,
#                      minlink1, minlink2,
#                      avglink1, avglink2]

    input:
        method: void
        file: none

    output:
        file: generated.h5
    logging:
        level: processes

    start_period: 2001   # first simulated period
    periods: 3
